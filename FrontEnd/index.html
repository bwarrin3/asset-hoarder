<!DOCTYPE html>
<!-- This is a comment to test something, again, again, again (add agaom every edit)-->
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>AssetHoarder</title>
        <link rel="stylesheet" href="style.css">
        <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    </head>
    <body>

        <div id="search-page">
            <!-- <div id="search-bg"></div> -->
            <div id="search-interface">
                <div>
                    <div id="search-logo"><img src="logo.png" /></div>
                    <input id="main-searchbar" placeholder="Search the Hoard" autofocus>
                </div>
                <div id="content-filters">
                    <div>
                        <img src="https://www.pngrepo.com/png/310911/180/image.png" class="filter-toggle-button" onclick="toggleFilter(this.parentElement);" />
                        <div class="filter-menu">
                            <div class="filter-menu-margin">
                                <div>
                                    <button class="toggle-button" onclick="toggleButton(this);">Photos</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Icons</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Textures</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Sprites</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <img src="https://cdn-icons-png.flaticon.com/128/59/59284.png" class="filter-toggle-button" onclick="toggleFilter(this.parentElement);" />
                        <div class="filter-menu">
                            <div class="filter-menu-margin">
                                <div>
                                    <button class="toggle-button" onclick="toggleButton(this);">Music</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Sound Effects</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Ambient</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Voice</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <img src="https://edusasha.com/wp-content/uploads/2017/05/video.png" class="filter-toggle-button" onclick="toggleFilter(this.parentElement);" />
                        <div class="filter-menu">
                            <div class="filter-menu-margin">
                                <div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <img src="https://cdn-icons-png.flaticon.com/128/1724/1724090.png" class="filter-toggle-button" onclick="toggleFilter(this.parentElement);" />
                        <div class="filter-menu">
                            <div class="filter-menu-margin">
                                <div>
                                    <button class="toggle-button" onclick="toggleButton(this);">Characters</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Objects</button>
                                    <button class="toggle-button" onclick="toggleButton(this);">Environments</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="explore-button" onclick="document.getElementById('browse-page').scrollIntoView({ behavior: 'smooth'});">
                Explore
            </div>
        </div>

        <div id="browse-page">
            <div id="browse-content">
                <script>

                document.getElementById("search-logo").style.height = (document.getElementById("main-searchbar").getBoundingClientRect().top - document.getElementById("search-interface").getBoundingClientRect().top - 10) + "px";
                document.getElementById("search-logo").style.top = "-" + (document.getElementById("main-searchbar").getBoundingClientRect().top - document.getElementById("search-interface").getBoundingClientRect().top + 10) + "px"

                function toggleFilter(filterElement)
                {
                    filterElement.classList.toggle("selected");
                    if (filterElement.classList.contains("selected"))
                    {
                        document.getElementById("content-filters").classList.add("selected");

                        setTimeout(() => {
                            filterElement.children[1].children[0].style.display = "block";
                        }, 100);
                    }
                    else
                    {
                        filterElement.children[1].children[0].style.display = "none";
                        filterElement.classList.add("selected");
                        setTimeout(() => {
                            filterElement.classList.remove("selected");
                            let found = false;
                            for (var child of document.getElementById("content-filters").children)
                            {
                                found = found || child.classList.contains("selected");
                            }
                            if (!found)
                                document.getElementById("content-filters").classList.remove("selected");
                        }, 0o0);
                    }
                }

                </script>
                <script type="text/babel">

                    const test_assets = [
                        {
                            "type": "image",
                            "file": "https://wallpapers.com/images/featured/cat-pictures-zc3gu0636kmldm04.jpg",
                            "title": "The Orange",
                            "width": 900,
                            "height": 563,
                        },
                        {
                            "type": "image",
                            "file": "https://wallpaper-house.com/data/out/6/wallpaper2you_103955.jpg",
                            "title": "Dinnertime",
                            "width": 1920,
                            "height": 1080,
                        },
                        {
                            "type": "image",
                            "file": "https://www.itl.cat/pngfile/big/47-478337_kitten-wallpapers-hd.jpg",
                            "title": "Leo the Magnificent",
                            "width": 1920,
                            "height": 1200,
                        },
                        {
                            "type": "image",
                            "file": "https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.kittyloaf.com%2Fwp-content%2Fuploads%2F2017%2F06%2FValentine_KittyLoaf_071417-375x375.png",
                            "title": "Pancake",
                            "width": 375,
                            "height": 375,
                        },


                        {
                            "type": "audio",
                            "file": "https://static.wikia.nocookie.net/undertale/images/6/63/Another_Medium_music.ogg",
                            "title": "Another Medium",
                            "duration": 2*60+22,
                        },
                        {
                            "type": "audio",
                            "file": "https://static.wikia.nocookie.net/undertale/images/1/12/It%27s_Raining_Somewhere_Else_music.ogg",
                            "title": "It's Raining Somewhere Else",
                            "duration": 2*60+50,
                        },
                        {
                            "type": "audio",
                            "file": "https://static.wikia.nocookie.net/undertale/images/9/93/Waterfall_%28Soundtrack%29_music.ogg",
                            "title": "Waterfall",
                            "duration": 2*60+6,
                        },
                        {
                            "type": "audio",
                            "file": "https://ia902902.us.archive.org/31/items/01.smellsliketeenspirit/01.Smells%20Like%20Teen%20Spirit.mp3",
                            "title": "Smells Like Teen Spirit",
                            "duration": 5*60+1,
                        },
                    ]

                    var current_audio = -1;
                    var setting_time = false;
                    var hover_time_counter = 0;

                    function toggle_audio(new_audio)
                    {
                        if (new_audio == current_audio)
                        {
                            document.getElementById("audio-player-" + current_audio).pause();
                            // document.getElementById("play-button-" + new_audio).style = "";
                            current_audio = -1;
                        }
                        else
                        {
                            if (current_audio != -1)
                            {
                                document.getElementById("audio-player-" + current_audio).pause();
                                // document.getElementById("play-button-" + current_audio).style = "";
                            }
                            document.getElementById("audio-player-" + new_audio).play();
                            // document.getElementById("play-button-" + new_audio).style.backgroundImage = "url(https://icon-library.com/images/pause-icon-transparent/pause-icon-transparent-8.jpg)";
                            current_audio = new_audio;
                        }
                    }

                    function Entry({ data })
                    {
                        let asset = data; //test_assets[Math.floor(Math.random() * test_assets.length)]
                        let asset_ID = asset.id //Math.floor(Math.random() * 2147483000);
                        if (Math.random() < 0.3)
                        {
                            asset = test_assets[4 + Math.floor(Math.random() * 4)]
                            asset_ID = Math.floor(Math.random() * 2147483000);
                        }

                        if (asset.type == "image")
                        {
                            let style_content = ".entry-" + asset_ID + `:hover > .image-preview {
                                z-index: 10; ` + (asset.width > asset.height ? `
                                width: calc(100% * ` + (asset.width / asset.height)  + `);
                                ` : `width: 100%;
                                height: calc(100% * ` + (asset.height / asset.width)  + `);`) + `
                                transform: scale(1.1);
                            }`;

                            if (asset.height > asset.width)
                            {
                                style_content += ".entry-" + asset_ID + ` .download-button {
                                    aspect-ratio: 1;
                                    width: 30%;
                                    height: auto;
                                }`;
                            }

                            return (
                                <div className={"entry image-entry entry-" + asset_ID}>
                                    <div className="image-preview"
                                        style={{ backgroundImage: `url(${asset.file})` }}
                                        loading="lazy">
                                        <div className="entry-title">{asset.title}</div>
                                        <a className="download-button" href={`/db/download/${asset.id}`} download></a>
                                    </div>

                                    {/* Preload the image to ensure it's fetched as soon as possible */}
                                    <link rel="preload" href={asset.file} as="image" />

                                    {/* Critical CSS for the image-entry styles */}
                                    <style>{style_content}</style>
                                </div>

                            );
                        }
                        else if (asset.type == "audio")
                        {
                            return (
                                <div id={"entry-" + asset_ID} className="entry audio-entry" onMouseOver={(event) => toggle_audio(asset_ID)} onMouseOut={(event) => toggle_audio(asset_ID)}>
                                    <a id={"play-button-" + asset_ID} className={"audio-play-button"} href={asset.file} download></a>
                                    <audio id={"audio-player-" + asset_ID}>
                                        <source src={asset.file} type="audio/ogg" />
                                    </audio>

                                    <div className="entry-title" onMouseOver={(event) => setting_time = true} onMouseOut={(event) => setting_time = false}>
                                        <div id={"media-progress-" + asset_ID} className="media-progress-bar">
                                            <div className="media-progress-bar-tip"></div>
                                        </div>
                                        {asset.title}
                                    </div>
                                </div>
                            );
                        }
                    }

                    function timer()
                    {
                        if (current_audio != -1)
                        {
                            document.getElementById("media-progress-" + current_audio).style.width = (document.getElementById("audio-player-" + current_audio).currentTime / document.getElementById("audio-player-" + current_audio).duration * 100) + "%";
                        }
                    }

                    var mouseX = 0.0;
                    var mouseY = 0.0;

                    window.addEventListener("mousemove", event => {

                        if (mouseX == event.clientX && mouseY == event.clientY)
                            hover_time_counter = -10;

                        mouseX = event.clientX;
                        mouseY = event.clientY;

                        if (setting_time)
                        {
                            hover_time_counter += 1;

                            if (hover_time_counter >= 5)
                                document.getElementById("audio-player-" + current_audio).currentTime = (
                                    document.getElementById("audio-player-" + current_audio).duration
                                    * (event.clientX - document.getElementById("entry-" + current_audio).getBoundingClientRect().left)
                                    / (document.getElementById("entry-" + current_audio).getBoundingClientRect().right - document.getElementById("entry-" + current_audio).getBoundingClientRect().left)
                                );
                        }
                        else
                            hover_time_counter = 0;
                    });

                    async function main()
                    {

                        try
                        {
                            const response = await fetch("https://capstone1.cs.kent.edu/db/assets");
                            if (!response.ok)
                            {
                                throw new Error(`Response status: ${response.status}`);
                            }

                            const json = await response.json();

                            // Remove Picsum and shuffle asset order
                            for (var i = 0; i < json.imageAssets.length; i++) {
                                if (json.imageAssets[i].StorageLocation.includes("picsum") || json.imageAssets[i].StorageLocation.includes("pixabay"))
                                {
                                    json.imageAssets.splice(i, 1);
                                    i--;
                                }
                            }
                            json.imageAssets.sort( () => Math.random() -0.5 );

                            var entry_list = [];
                            for (var i = 0; i < 30; i++)
                            {
                                let entry = {
                                    "type": "image",
                                    "id": json.imageAssets[i].Id,
                                    "file": json.imageAssets[i].StorageLocation,
                                    "title": "",//json.imageAssets[i].Name,
                                    "width": json.imageAssets[i].Width,
                                    "height": json.imageAssets[i].Height,
                                };
                                entry_list.push(<Entry data={entry} />)
                            }

                            const container = document.getElementById('browse-content');
                            const root = ReactDOM.createRoot(container);
                            root.render(entry_list);
                        }
                        catch (error)
                        {
                            console.error(error.message);
                        }
                    }

                    /*
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        var entries = JSON.parse(this.responseText).assets;
                        var entry_list = [];
                        for (var i = 0; i < 100; i++) {
                            entry_list.push(<Entry data={entries[i]} />)
                        }

                        const container = document.getElementById('browse-content');
                        const root = ReactDOM.createRoot(container);
                        root.render(entry_list);
                    };
                    xhttp.open("GET", "http://174.104.199.92:5000/data/assets", true);
                    xhttp.send();
                    */

                    setInterval(timer, 33);
                    main();

                </script>
            </div>
        </div>

    </body>
</html>
